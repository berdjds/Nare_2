#!/usr/bin/expect -f
set timeout 60
spawn ssh root@213.136.80.87
expect "password:"
send "dC7Be3(2u2j\r"
expect "~]#"

send "cd /tmp\r"
expect "~]#"

send "echo 'ðŸ“¦ Loading Docker image...'\r"
expect "~]#"

send "docker load < naresima-latest.tar.gz\r"
expect "~]#"

send "echo 'ðŸš€ Starting container...'\r"
expect "~]#"

send "docker run -d --name naresima-app --restart always --network web -e NODE_ENV=production -v /root/productionapp/nare-travel/data:/app/data -v /root/productionapp/nare-travel/public/images/uploads:/app/public/images/uploads -l \"traefik.enable=true\" -l \"traefik.http.routers.nare.rule=Host(\\\`berdjds.com\\\`) || Host(\\\`www.berdjds.com\\\`)\" -l \"traefik.http.routers.nare.entrypoints=web\" -l \"traefik.http.routers.nare.middlewares=redirect-to-https\" -l \"traefik.http.routers.nare-secure.rule=Host(\\\`berdjds.com\\\`) || Host(\\\`www.berdjds.com\\\`)\" -l \"traefik.http.routers.nare-secure.entrypoints=websecure\" -l \"traefik.http.routers.nare-secure.tls.certresolver=le\" -l \"traefik.http.services.nare.loadbalancer.server.port=3000\" naresima:latest\r"
expect "~]#"

send "sleep 15\r"
expect "~]#"

send "echo 'ðŸ“Š Container status:'\r"
expect "~]#"

send "docker ps | grep naresima\r"
expect "~]#"

send "echo ''\r"
expect "~]#"

send "echo 'ðŸ“ Logs:'\r"
expect "~]#"

send "docker logs --tail=20 naresima-app\r"
expect "~]#"

send "echo ''\r"
expect "~]#"

send "echo 'ðŸ”§ Restarting Traefik...'\r"
expect "~]#"

send "docker restart traefik\r"
expect "~]#"

send "echo ''\r"
expect "~]#"

send "echo 'ðŸ§¹ Cleanup...'\r"
expect "~]#"

send "rm -f /tmp/naresima-latest.tar.gz\r"
expect "~]#"

send "echo 'âœ… Deployment complete!'\r"
expect "~]#"

send "exit\r"
expect eof
